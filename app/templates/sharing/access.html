{% extends "base.html" %}
{% block title %}Shared File — SecureMedia{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{{ url_for('media.dashboard') }}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('sharing.received') }}">Shared with Me</a></li>
    <li class="breadcrumb-item active">Access File</li>
  </ol>
</nav>

<div class="row justify-content-center">
  <div class="col-lg-8">
    <!-- Share info card -->
    <div class="card p-4 mb-4">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle d-flex align-items-center justify-content-center me-3"
             style="width:56px;height:56px;background:var(--sm-surface-alt);border:1px solid var(--sm-border)">
          {% if media.mime_type and 'video' in media.mime_type %}
            <i class="bi bi-film" style="font-size:1.5rem;color:var(--sm-primary)"></i>
          {% else %}
            <i class="bi bi-music-note-beamed" style="font-size:1.5rem;color:var(--sm-primary)"></i>
          {% endif %}
        </div>
        <div>
          <h4 class="mb-0 fw-bold">{{ media.original_filename }}</h4>
          <small class="text-muted">
            Shared by <strong>{{ token.sender.username }}</strong>
            &middot; {{ "%.2f"|format(media.file_size / 1048576) }} MB
          </small>
        </div>
      </div>

      <!-- Token status banner -->
      <div class="p-3 rounded mb-4" style="background:var(--sm-surface-alt);border:1px solid var(--sm-border)">
        <div class="row g-3 text-center">
          <div class="col-6 col-md-3">
            <small class="text-muted d-block">Status</small>
            {% if token.status == 'pending' %}
              <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>Pending Verification</span>
            {% elif token.status == 'verified' %}
              <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Verified</span>
            {% elif token.status == 'used' %}
              <span class="badge bg-info"><i class="bi bi-play-circle me-1"></i>Accessed</span>
            {% elif token.status == 'revoked' %}
              <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Revoked</span>
            {% endif %}
          </div>
          <div class="col-6 col-md-3">
            <small class="text-muted d-block">Permission</small>
            {% if token.allow_download %}
              <span class="badge bg-primary"><i class="bi bi-download me-1"></i>Stream + Download</span>
            {% else %}
              <span class="badge bg-secondary"><i class="bi bi-play-circle me-1"></i>Stream Only</span>
            {% endif %}
          </div>
          <div class="col-6 col-md-3">
            <small class="text-muted d-block">Expires</small>
            <span class="fw-semibold small {% if token.is_expired %}text-danger{% endif %}">
              {{ token.expires_at.strftime('%b %d, %Y %H:%M') }}
              {% if token.is_expired %}<br><small>(expired)</small>{% endif %}
            </span>
          </div>
          <div class="col-6 col-md-3">
            <small class="text-muted d-block">Encrypted</small>
            <span class="badge bg-success"><i class="bi bi-lock-fill me-1"></i>AES-256-GCM</span>
          </div>
        </div>
      </div>

      <!-- ============ GATE: Verify Identity ============ -->
      {% if not already_verified %}
      <div class="card p-4 text-center" style="border-color:var(--sm-primary)">
        <i class="bi bi-shield-lock" style="font-size:3rem;color:var(--sm-primary)"></i>
        <h5 class="mt-3 fw-bold">Identity Verification Required</h5>
        <p class="text-muted mb-3">
          To unlock this encrypted file, please re-enter your password to confirm your identity.
        </p>
        <form method="POST" action="{{ url_for('sharing.verify', token=token.token) }}" class="mx-auto" style="max-width:320px">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
            <input type="password" name="password" class="form-control" placeholder="Enter your password"
                   required autofocus>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-unlock me-1"></i>Verify &amp; Unlock
          </button>
        </form>
        <small class="text-muted mt-3 d-block">
          <i class="bi bi-info-circle me-1"></i>
          This ensures only you can access the decrypted content.
        </small>
      </div>

      {% else %}
      <!-- ============ UNLOCKED: Show Actions ============ -->
      <div class="text-center mb-4">
        <div class="d-inline-flex align-items-center px-3 py-2 rounded"
             style="background:rgba(0,200,83,.1);border:1px solid rgba(0,200,83,.3)">
          <i class="bi bi-check-circle-fill text-success me-2"></i>
          <span class="fw-semibold text-success">Identity Verified — File Unlocked</span>
        </div>
      </div>

      <div class="d-flex gap-3 justify-content-center flex-wrap">
        <!-- Stream button -->
        {% if token.allow_stream %}
        <a href="{{ url_for('sharing.stream', token=token.token) }}" class="btn btn-primary btn-lg">
          <i class="bi bi-play-circle me-2"></i>Stream Now
        </a>
        {% endif %}

        <!-- Download button (conditional) -->
        {% if token.allow_download %}
        <a href="{{ url_for('sharing.download', token=token.token) }}" class="btn btn-outline-light btn-lg">
          <i class="bi bi-download me-2"></i>Download Decrypted
        </a>
        {% else %}
        <button class="btn btn-outline-secondary btn-lg" disabled title="Download not permitted by policy">
          <i class="bi bi-lock me-2"></i>Download Restricted
        </button>
        {% endif %}
      </div>

      <div class="text-center mt-3">
        <small class="text-muted">
          <i class="bi bi-clock me-1"></i>
          Token valid until {{ token.expires_at.strftime('%b %d, %Y at %H:%M UTC') }}
        </small>
      </div>
      {% endif %}
    </div>

    <!-- Security info -->
    <div class="card p-3">
      <div class="d-flex align-items-start">
        <i class="bi bi-shield-check me-3 mt-1" style="font-size:1.5rem;color:var(--sm-primary)"></i>
        <div>
          <h6 class="fw-bold mb-1">Encrypted Delivery</h6>
          <p class="text-muted small mb-0">
            This file is stored encrypted with AES-256-GCM. Decryption happens on-the-fly
            after identity verification. All access is logged and auditable by the admin.
            The owner or admin can revoke your access at any time.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
