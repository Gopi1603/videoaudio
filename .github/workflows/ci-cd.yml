# ── SecureMedia — CI/CD Pipeline ─────────────────────────────────────────
# Runs on every push and PR to main.
# Jobs: lint → test → build Docker image → (optional) deploy.
# ────────────────────────────────────────────────────────────────────────

name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  FERNET_MASTER_KEY: "t2JVH7Bj3GkX6vN8QfW0MpYrA5z1LcDs9iUoEhKlRxw="

jobs:
  # ── 1. Lint ──
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install flake8

      - name: Run flake8
        run: |
          flake8 app/ tests/ --max-line-length=120 --ignore=E501,W503,E402

  # ── 2. Test ──
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libgl1-mesa-glx

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run test suite with coverage
        run: |
          python -m pytest tests/ -v --tb=short --cov=app --cov-report=term-missing --cov-report=html

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  # ── 3. Build Docker Image ──
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t securemedia:${{ github.sha }} .
          docker build -t securemedia:latest .

      - name: Test Docker image health
        run: |
          docker run -d --name sm-test \
            -e SECRET_KEY=ci-test-key \
            -e FERNET_MASTER_KEY=${{ env.FERNET_MASTER_KEY }} \
            -p 8000:8000 \
            securemedia:latest
          sleep 5
          curl -f http://localhost:8000/health || exit 1
          docker stop sm-test

  # ── 4. Push to Registry (on tag) ──
  push:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/securemedia:${{ github.ref_name }}
            ${{ secrets.DOCKER_USERNAME }}/securemedia:latest

  # ── 5. Deploy (on tag) ──
  deploy:
    runs-on: ubuntu-latest
    needs: push
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/securemedia
            docker compose pull
            docker compose up -d --force-recreate
            docker compose exec web python -c "from app import create_app, db; app=create_app('config.ProductionConfig'); app.app_context().push(); db.create_all(); print('DB migrated')"
            echo "Deployed ${{ github.ref_name }} successfully"
